<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multiplayer Gameplay (Synchronization and Buffers) | EmbeddedFPSExample</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/EmbeddedFPSExample/assets/css/0.styles.32e58400.css" as="style"><link rel="preload" href="/EmbeddedFPSExample/assets/js/app.debd0cf8.js" as="script"><link rel="preload" href="/EmbeddedFPSExample/assets/js/2.6b282e9d.js" as="script"><link rel="preload" href="/EmbeddedFPSExample/assets/js/14.62a0b14a.js" as="script"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/10.021f36e7.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/11.710a60b5.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/12.dabfb87e.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/13.6ea62ec4.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/15.e4fe2066.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/16.92f92ea2.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/17.a10b7396.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/18.1f2cce65.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/19.c0a5a8eb.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/20.2f1b2705.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/3.2e9c32b1.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/4.5667f98c.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/5.a89d39a3.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/6.1e5c2305.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/7.237b2ecd.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/8.20703bf5.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/9.7cddb3eb.js">
    <link rel="stylesheet" href="/EmbeddedFPSExample/assets/css/0.styles.32e58400.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/EmbeddedFPSExample/" class="home-link router-link-active"><!----> <span class="site-name">EmbeddedFPSExample</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/EmbeddedFPSExample/guide/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/EmbeddedFPSExample/guide/setting-up-the-projects.html" class="sidebar-link">Setting up the projects</a></li><li><a href="/EmbeddedFPSExample/guide/client-basics-and-login-system-part-1.html" class="sidebar-link">Client Basics and Login System Part 1</a></li><li><a href="/EmbeddedFPSExample/guide/server-basics-and-login-system.html" class="sidebar-link">Server Basics and Login System</a></li><li><a href="/EmbeddedFPSExample/guide/room-system-part-1-server-side.html" class="sidebar-link">Room System Part 1 (Server-Side)</a></li><li><a href="/EmbeddedFPSExample/guide/client-login-system-part-2-and-lobby.html" class="sidebar-link">Client Login System Part 2 and Lobby</a></li><li><a href="/EmbeddedFPSExample/guide/room-system-part-2-server-side.html" class="sidebar-link">Room System Part 2 (Server-Side)</a></li><li><a href="/EmbeddedFPSExample/guide/player-movement-interpolation-and-client-side-prediction.html" class="sidebar-link">Player-Movement, Interpolation and Client Side Prediction</a></li><li><a href="/EmbeddedFPSExample/guide/multiplayer-gameplay.html" aria-current="page" class="active sidebar-link">Multiplayer Gameplay (Synchronization and Buffers)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/EmbeddedFPSExample/guide/reconciliation.html" class="sidebar-link">Reconciliation</a></li><li><a href="/EmbeddedFPSExample/guide/health-shooting-lag-Compensation.html" class="sidebar-link">Health, Shooting, Lag Compensation</a></li><li><a href="/EmbeddedFPSExample/guide/networking-discussion.html" class="sidebar-link">Networking Discussion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="multiplayer-gameplay-synchronization-and-buffers"><a href="#multiplayer-gameplay-synchronization-and-buffers" class="header-anchor">#</a> Multiplayer Gameplay (Synchronization and Buffers)</h1> <p>Finally we can start to develop the actual multiplayer part of our game.
Before we start spawning players on our server we first have to lay out a simple system on how the player and the server will be exchanging information. We will use this basic scheme:</p> <ul><li>Once the client loaded the Game scene it will send a GameJoinRequest to the server(An empty message)</li> <li>The Server will respond with information about the current room (All spawned players and their states)</li> <li>From that point of the server will send information every frame to the client. The following information types exist:
<ul><li>PlayerSpawnData (Whenever a new player joined we send that information to all connected clients)</li> <li>PlayerStateData (We have already implemented this)</li> <li>PlayerDespawnData (Opposite of PlayerSpawnData, tells the client to despawn a player)</li></ul></li> <li>The client also sends inputs every frame to the server (We have already done that)</li></ul> <p>So let's add these to our NetworkingData script:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">PlayerSpawnData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">ushort</span></span> Id<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> Name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Vector3</span> Position<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PlayerSpawnData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">ushort</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Vector3</span> position<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        Position <span class="token operator">=</span> position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Name <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">PlayerDespawnData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">ushort</span></span> Id<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PlayerDespawnData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">ushort</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">GameUpdateData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">uint</span></span> Frame<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> SpawnData<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PlayerDespawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> DespawnData<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PlayerStateData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> UpdateData<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">GameUpdateData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">uint</span></span> frame<span class="token punctuation">,</span> <span class="token class-name">PlayerStateData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> updateData<span class="token punctuation">,</span> <span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> spawnData<span class="token punctuation">,</span> <span class="token class-name">PlayerDespawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> despawnData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Frame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
        UpdateData <span class="token operator">=</span> updateData<span class="token punctuation">;</span>
        DespawnDataData <span class="token operator">=</span> despawnData<span class="token punctuation">;</span>
        SpawnDataData <span class="token operator">=</span> spawnData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Frame <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SpawnData <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadSerializables</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerSpawnData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DespawnData <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadSerializables</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerDespawnData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UpdateData <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadSerializables</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerStateData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>SpawnData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>DespawnData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>UpdateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And also add a struct containing the game start information:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">GameStartData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">uint</span></span> OnJoinServerTick<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> Players<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">GameStartData</span><span class="token punctuation">(</span><span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> players<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">uint</span></span> serverTick<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Players <span class="token operator">=</span> players<span class="token punctuation">;</span>
        OnJoinServerTick <span class="token operator">=</span> serverTick<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OnJoinServerTick <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Players <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadSerializables</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerSpawnData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>OnJoinServerTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Players<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Also add some Tags so that we can send messages containing those types of data:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    GameJoinRequest <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
    GameStartDataResponse <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">,</span>
    GameUpdate <span class="token operator">=</span> <span class="token number">202</span><span class="token punctuation">,</span>
</code></pre></div><p>Now let's create a script that talks to server once the Game scene is loaded.</p> <ul><li>Create a GameManager script in the Scripts folder</li> <li>Create an empty gameobject name it &quot;GameManager&quot;.</li> <li>Add the GameManager script to that gameobject.</li> <li>Drag the Player gameobject into the Prefabs folder, then delete it in the Scene</li></ul> <p>Open The GameManager script and add some variables:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">DarkRift</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">DarkRift<span class="token punctuation">.</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GameManager</span> Instance<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">ushort</span><span class="token punctuation">,</span> ClientPlayer<span class="token punctuation">&gt;</span></span> players <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">ushort</span><span class="token punctuation">,</span> ClientPlayer<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Prefabs&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">GameObject</span> PlayerPrefab<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">uint</span></span> ClientTick <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">uint</span></span> LastReceivedServerTick <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Destroy</span><span class="token punctuation">(</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token function">DontDestroyOnLoad</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>ClientTick is the frame number that the client is actually simulating with FixedUpdate, which is also it's input tick, it will be important later. LastRecievedServerTick is the tick of the last message received from the server. The Dictionary will be used to keep track of players.</p> <p>Next we want to send a message to the server in Start() and we want to receive messages and process them:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        GlobalManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>MessageReceived <span class="token operator">-=</span> OnMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>MessageReceived <span class="token operator">+=</span> OnMessage<span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">CreateEmpty</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>GameJoinRequest<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">MessageReceivedEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Tags<span class="token punctuation">)</span>message<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">case</span> Tags<span class="token punctuation">.</span>GameStartDataResponse<span class="token punctuation">:</span>
                    <span class="token function">OnGameJoinAccept</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GameStartData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> Tags<span class="token punctuation">.</span>GameUpdate<span class="token punctuation">:</span>
                    <span class="token function">OnGameUpdate</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GameUpdateData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGameJoinAccept</span><span class="token punctuation">(</span><span class="token class-name">GameStartData</span> gameStartData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        LastReceivedServerTick <span class="token operator">=</span> gameStartData<span class="token punctuation">.</span>OnJoinServerTick<span class="token punctuation">;</span>
        ClientTick <span class="token operator">=</span> gameStartData<span class="token punctuation">.</span>OnJoinServerTick<span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">PlayerSpawnData</span> playerSpawnData <span class="token keyword">in</span> gameStartData<span class="token punctuation">.</span>Players<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">SpawnPlayer</span><span class="token punctuation">(</span>playerSpawnData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGameUpdate</span><span class="token punctuation">(</span><span class="token class-name">GameUpdateData</span> gameUpdateData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SpawnPlayer</span><span class="token punctuation">(</span><span class="token class-name">PlayerSpawnData</span> playerSpawnData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Next <strong>delete the Start() function from the clientPlayer</strong> and add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">ushort</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> playerName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerName <span class="token operator">=</span> playerName<span class="token punctuation">;</span>
    NameText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>playerName<span class="token punctuation">;</span>
    <span class="token function">SetHealth</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>PlayerId <span class="token operator">==</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        isOwn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">SetParent</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localRotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>
        interpolation<span class="token punctuation">.</span>CurrentData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We will initialize spawned players with this function. Our own player will get a camera Attached and we mark him as our own player.</p> <p>Also add code to update the players based on data from the server:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnServerDataUpdate</span><span class="token punctuation">(</span><span class="token class-name">PlayerStateData</span> playerStateData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isOwn<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        Interpolation<span class="token punctuation">.</span><span class="token function">SetFramePosition</span><span class="token punctuation">(</span>playerStateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>(We use the part in isOwn later for reconciliation)</p> <p>In the Fixedupdate function put everything in a if(IsOwn){} bracket it should look like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isOwn<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">bool</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> inputs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">bool</span></span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>D<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Space<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetMouseButton</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        yaw <span class="token operator">+=</span> Input<span class="token punctuation">.</span><span class="token function">GetAxis</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse X&quot;</span><span class="token punctuation">)</span> <span class="token operator">*</span> sensitivityX<span class="token punctuation">;</span>
        pitch <span class="token operator">+=</span> Input<span class="token punctuation">.</span><span class="token function">GetAxis</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse Y&quot;</span><span class="token punctuation">)</span> <span class="token operator">*</span> sensitivityY<span class="token punctuation">;</span>

        <span class="token class-name">Quaternion</span> rotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span><span class="token function">Euler</span><span class="token punctuation">(</span>pitch<span class="token punctuation">,</span> yaw<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PlayerInputData</span> inputData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerInputData</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>LastReceivedServerTick <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        transform<span class="token punctuation">.</span>position <span class="token operator">=</span> interpolation<span class="token punctuation">.</span>CurrentData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
        <span class="token class-name">PlayerStateData</span> nextStateData <span class="token operator">=</span> playerLogic<span class="token punctuation">.</span><span class="token function">GetNextFrameData</span><span class="token punctuation">(</span>inputData<span class="token punctuation">,</span> interpolation<span class="token punctuation">.</span>CurrentData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        interpolation<span class="token punctuation">.</span><span class="token function">SetFramePosition</span><span class="token punctuation">(</span>nextStateData<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span> Tags<span class="token punctuation">.</span>GamePlayerInput<span class="token punctuation">,</span> inputData<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        reconciliationHistory<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReconciliationInfo</span><span class="token punctuation">(</span>GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ClientTick<span class="token punctuation">,</span> nextStateData<span class="token punctuation">,</span> inputData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can fill in the SpawnPlayer function in the GameManager:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SpawnPlayer</span><span class="token punctuation">(</span><span class="token class-name">PlayerSpawnData</span> playerSpawnData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">GameObject</span> go <span class="token operator">=</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>PlayerPrefab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ClientPlayer</span> player <span class="token operator">=</span> go<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ClientPlayer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    player<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span>playerSpawnData<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> playerSpawnData<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    players<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>playerSpawnData<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now there is still the OnGameUpdate function left. this function is called whenever we receive a GameUpdateData from the server. We could just execute all events in that data like spawning players or moving them as soon as we receive a message but if we do that we run into a few problems which we havo to solve first...</p> <h3 id="buffers-for-game-networking"><a href="#buffers-for-game-networking" class="header-anchor">#</a> Buffers for Game Networking</h3> <p>Let's assume we have a server and a client both running at 50 frames per second so they run a Tick every 20 ms. The server will send a message every Tick and the client will receive a message and perform some actions. On a time line this would look like this:</p> <p>(messages have a constant delay of 15 ms)</p> <ul><li>0 ms: Server sends message 0 to client, client received no messages so waits</li> <li>15 ms: Client receives message 0 and will perform actions in the next frame</li> <li>20 ms: Server sends 1, client performs 0</li> <li>35 ms: client receives 1</li> <li>40 ms server sends 2, client performs 1
......</li></ul> <p>works fine so far but in reality sending messages will not have a constant delay so let's look at another example.</p> <p>(messages have a delay of 15-30 ms)</p> <ul><li>0 ms: server sends 0(with delay 17 ms), client performs nothing</li> <li>17 ms: client receives 0</li> <li>20 ms: server sends 1(with delay 28 ms), client performs 0</li> <li>40 ms: server sends 2(with delay 16 ms), client performs nothing(has received nothing)</li> <li>48 ms: client receives 1</li> <li>56 ms: client receives 2</li> <li>60 ms: server sends 3(with delay 25 ms), client performs ??? maybe just 1 and store 2 or both or just 2 and discard 1 or  what.....</li></ul> <p>This leads to jitter (Players bouncing forward and backwards or jumping small distances) or even worse it could lead to spells being not casted if you discard messages. So how can we handle that problem. How it's done differs from game to game, we will use a very basic approach with the idea of fulfilling the following requirements:</p> <ul><li>When we send a message from the server we will receive it no matter what</li> <li>Messages arrive always in a sorted order</li> <li>No jittering -&gt; We (almost)always want to perform 1 message per frame</li> <li>No discarding -&gt; We want to perform every message</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>One could argue that these are bad requirements for an FPS. For instance we could do movement completely fine with unordered and unreliable(not all messages arrive) messages, because leaving out a movement update would barely make a difference and interpolation would smooth it out. I will add a section &quot;Networking Discussion&quot; at the end of this tutorial where I go further into details like this.</p></div> <p>Luckily the TCP protcol delivers reliable and sorted messages(on the cost of performance and additional delay in the case of bad connections) so we only have to solve the jittering and discarding problem.</p> <p>Since this is a problem that each game has to face there exists a solution to it already. It's called a buffer or dejitter buffer. A buffer stores the elements it receives for a short time in a list and allows us to pull an element out each frame. Create a new Buffer script in Scripts/shared and fill it with the following code:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Buffer<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> elements<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> bufferSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> counter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> correctionTollerance<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> bufferSize<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> correctionTollerance<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">=</span> bufferSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>correctionTollerance <span class="token operator">=</span> correctionTollerance<span class="token punctuation">;</span>
        elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Queue<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Count <span class="token operator">=&gt;</span> elements<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">T</span> element<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        elements<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">int</span></span> size <span class="token operator">=</span> elements<span class="token punctuation">.</span>Count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> bufferSize<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> bufferSize<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            counter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">&gt;</span> correctionTollerance<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">int</span></span> amount <span class="token operator">=</span> elements<span class="token punctuation">.</span>Count <span class="token operator">-</span> bufferSize<span class="token punctuation">;</span>
                <span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">T</span><span class="token punctuation">[</span>amount<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> amount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> temp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> bufferSize<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            counter<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span>counter <span class="token operator">&gt;</span> correctionTollerance<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">T</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>elements<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> elements<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">T</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>the Get() generates garbage which you should avoid as much as possible in generic classes like this. You could reuse an ArraySegment which you pass into this function to get rid of that allocation.</p></div> <p>So how does it work. First the constructor takes 2 parameters. bufferSize is the ideal size that the buffer should have, the buffer will try to always keep that many elements in it. If we increase this value we add delay to the execution of messages but reduce the chance of getting jitter. By how much exactly? increasing bufferSize by one will add a delay of FixedDeltaTime (in our case 25 ms because we have 40 FixedUpdates per second) but will also allow the ping of the player to bounce between twice that amount.</p> <p>For Instance if we take a buffer with size, 3 a player would have 75 ms more delay but he could still play fine without jitter even if his ping spikes between 30 ms and 130 ms (130-30 &lt; 75*20). Now we have to decide on a bufferSize for our game. We will go for 1 (add a delay of 25 ms but allow the ping to vary up to 50 ms.)</p> <p>Let's add a buffer to our GameManager:</p> <div class="language- extra-class"><pre class="language-text"><code>    private Buffer&lt;GameUpdateData&gt; gameUpdateDataBuffer = new Buffer&lt;GameUpdateData&gt;(1, 1);
</code></pre></div><p>and change the OnGameUpdate function to:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGameUpdate</span><span class="token punctuation">(</span><span class="token class-name">GameUpdateData</span> gameUpdateData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gameUpdateDataBuffer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>gameUpdateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now in FixedUpdate we pull objects from the buffer and process them:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ClientTick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">GameUpdateData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> receivedGameUpdateData <span class="token operator">=</span> gameUpdateDataBuffer<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">GameUpdateData</span> data <span class="token keyword">in</span> receivedGameUpdateData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">UpdateClientGameState</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateClientGameState</span><span class="token punctuation">(</span><span class="token class-name">GameUpdateData</span> gameUpdateData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    LastReceivedServerTick <span class="token operator">=</span> gameUpdateData<span class="token punctuation">.</span>Frame<span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">PlayerSpawnData</span> data <span class="token keyword">in</span> gameUpdateData<span class="token punctuation">.</span>SpawnDataData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>Id <span class="token operator">!=</span> ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>PlayerId<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">SpawnPlayer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">PlayerDespawnData</span> data <span class="token keyword">in</span> gameUpdateData<span class="token punctuation">.</span>DespawnDataData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>players<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Destroy</span><span class="token punctuation">(</span>players<span class="token punctuation">[</span>data<span class="token punctuation">.</span>Id<span class="token punctuation">]</span><span class="token punctuation">.</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            players<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">PlayerStateData</span> data <span class="token keyword">in</span> gameUpdateData<span class="token punctuation">.</span>UpdateData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ClientPlayer</span> p<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>players<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token keyword">out</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">OnServerDataUpdate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The client is now ready for multiplayer gameplay.
So let's swap to the server project:</p> <ul><li>Create a new GameObject and name it &quot;Player&quot;</li> <li>Add a CharacterController to it and set the height to 0</li> <li>Add the PlayerLogic script as a component to it</li> <li>In the PlayerLogic component set WalkSpeed = 8, GravityConstant = 2, JumpStrength = 11 (same values as on the client)</li> <li>Create a ServerPlayer script in the Scripts folder.</li> <li>Drag the Player GameObject into the prefabs folder and delete it from the scene.</li></ul> <p>First of all the Room script should store and interact with ServerPlayers, to do that we have to store all players which are currently inside the room. Open the Room script and add the following to the Public Fields variables:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">uint</span></span> ServerTick<span class="token punctuation">;</span>
</code></pre></div><p>We will also need a reference to the player prefab to spawn it:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Prefabs&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token class-name">GameObject</span> playerPrefab<span class="token punctuation">;</span>
</code></pre></div><p>Finally add Lists to store the room state:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>ServerPlayer<span class="token punctuation">&gt;</span></span> serverPlayers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ServerPlayer<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>PlayerStateData<span class="token punctuation">&gt;</span></span> playerStateData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>PlayerStateData<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>PlayerSpawnData<span class="token punctuation">&gt;</span></span> playerSpawnData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>PlayerSpawnData<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>PlayerDespawnData<span class="token punctuation">&gt;</span></span> playerDespawnData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>PlayerDespawnData<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Add a function to get the spawn data for all players currently in the room. New players will need this data so that they can spawn in all other existing players.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GetSpawnDataForAllPlayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> playerSpawnData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerSpawnData</span><span class="token punctuation">[</span>serverPlayers<span class="token punctuation">.</span>Count<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serverPlayers<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ServerPlayer</span> p <span class="token operator">=</span> serverPlayers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        playerSpawnData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">GetPlayerSpawnData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> playerSpawnData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now let's create a function to react on a GameJoinRequest from a client:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">JoinPlayerToGame</span><span class="token punctuation">(</span><span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">GameObject</span> go <span class="token operator">=</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>PlayerPrefab<span class="token punctuation">,</span> transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerPlayer</span> player <span class="token operator">=</span> go<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ServerPlayer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverPlayers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerStateData<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    player<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span>Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> clientConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>

    spawnDatas<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span><span class="token function">GetPlayerSpawnData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This will create a player and initialize it. Also note that we instatiate it as a child of the room which will put it automatically into the scene of this room which means it will be in the physics system which belongs to this room. We still have to write that initialize function but first we will also add a ServerPlayer field to our ClientConnection. Open the ClientConnection script and add to the Public Fields:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token return-type class-name">ServerPlayer</span> Player <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><p>Then open the ServerPlayer script and add the following:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">DarkRift</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">DarkRift<span class="token punctuation">.</span>Server</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequireComponent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">PlayerLogic</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerPlayer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Room</span> room<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PlayerStateData</span> currentPlayerStateData<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Buffer<span class="token punctuation">&lt;</span>PlayerInputData<span class="token punctuation">&gt;</span></span> inputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Buffer<span class="token punctuation">&lt;</span>PlayerInputData<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerLogic</span> PlayerLogic <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">uint</span></span> InputTick <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IClient</span> Client <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerStateData</span> CurrentPlayerStateData <span class="token operator">=&gt;</span> currentPlayerStateData<span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        PlayerLogic <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerLogic<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name">Vector3</span> position<span class="token punctuation">,</span> <span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConnection <span class="token operator">=</span> clientConnection<span class="token punctuation">;</span>
        room <span class="token operator">=</span> clientConnection<span class="token punctuation">.</span>Room<span class="token punctuation">;</span>
        Client <span class="token operator">=</span> clientConnection<span class="token punctuation">.</span>Client<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConnection<span class="token punctuation">.</span>Player <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        
        currentPlayerStateData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span>Client<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> position<span class="token punctuation">,</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InputTick <span class="token operator">=</span> room<span class="token punctuation">.</span>ServerTick<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> playerSpawnData <span class="token operator">=</span> room<span class="token punctuation">.</span><span class="token function">GetSpawnDataForAllPlayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>GameStartDataResponse<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GameStartData</span><span class="token punctuation">(</span>playerSpawnData<span class="token punctuation">,</span> room<span class="token punctuation">.</span>ServerTick<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>The Initialize function we created, firstly assigns a lot of references for later use and then generates a GameStartData out of the information from our Room and sends it back as GameStartDataResponse. After that point the client will be an official player on the server and can move and be seen by other players.</p> <p>So let's add a bit of logic to the ServerPlayer:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RecieveInput</span><span class="token punctuation">(</span><span class="token class-name">PlayerInputData</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        inputBuffer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerStateData</span> <span class="token function">PlayerUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>Length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">PlayerInputData</span> input <span class="token operator">=</span> inputs<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            InputTick<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inputs<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                InputTick<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">||</span> inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                input<span class="token punctuation">.</span>LookDirection <span class="token operator">=</span> inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>LookDirection<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            currentPlayerStateData <span class="token operator">=</span> PlayerLogic<span class="token punctuation">.</span><span class="token function">GetNextFrameData</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> currentPlayerStateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> currentPlayerStateData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
        transform<span class="token punctuation">.</span>localRotation <span class="token operator">=</span> currentPlayerStateData<span class="token punctuation">.</span>LookDirection<span class="token punctuation">;</span>
        <span class="token keyword">return</span> currentPlayerStateData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerSpawnData</span> <span class="token function">GetPlayerSpawnData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerSpawnData</span><span class="token punctuation">(</span>Client<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> ClientConnection<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> transform<span class="token punctuation">.</span>localPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>ReceiveInput will just add inputs from the client to the input buffer of the server player(We need a buffer on both sides we don't want the server to miss inputs too). GetPlayerSpawnData will be used to generate information for new players.</p> <p>PlayerUpdate Will read and input from the buffer and perform it and store a PlayerStateData in the room which will be used to generate GameUpdateDatas later.</p> <p>No we can write the main game routine in the Room script:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ServerTick<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serverPlayers<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">ServerPlayer</span> player <span class="token operator">=</span> serverPlayers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            playerStateData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">PlayerUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Send update message to all players.</span>
        <span class="token class-name">PlayerStateData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> playerStateDataArray <span class="token operator">=</span> playerStateData<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> playerSpawnDataArray <span class="token operator">=</span> playerSpawnData<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PlayerDespawnData<span class="token punctuation">[</span><span class="token punctuation">]</span></span> playerDespawnDataArray <span class="token operator">=</span> playerDespawnData<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">ServerPlayer</span> p <span class="token keyword">in</span> serverPlayers<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>GameUpdate<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GameUpdateData</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>InputTick<span class="token punctuation">,</span> playerStateDataArray<span class="token punctuation">,</span> playerSpawnDataArray<span class="token punctuation">,</span> playerDespawnDataArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        playerSpawnData<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerDespawnData<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>It is very simple, it just performs an update on each player and then sends each player the new room state and resets all data in the room at the end.</p> <p>The last thing that is left to do is actually calling functions when we receive anything from the client, so open the ClientConnection script and add to the Switch these 2 cases:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">case</span> Tags<span class="token punctuation">.</span>GameJoinRequest<span class="token punctuation">:</span>
    Room<span class="token punctuation">.</span><span class="token function">JoinPlayerToGame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> Tags<span class="token punctuation">.</span>GamePlayerInput<span class="token punctuation">:</span>
    Player<span class="token punctuation">.</span><span class="token function">RecieveInput</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerInputData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally assign all the references of the player prefab in the editor. Now our multiplayer game is playable, you can test it out by building and starting 2 clients and running around. You will see that the players get synchronized to each other and that they can collide with each other.</p> <p>There is a small thing that we have to fix. The RemovePlayerFromRoom function in our room doesn't remove players from the game yet when we reconnect. So open the Room script and replace the function with this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RemovePlayerFromRoom</span><span class="token punctuation">(</span><span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">Destroy</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerDespawnData<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerDespawnData</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ClientConnections<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverPlayers<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">.</span>Player<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientConnection<span class="token punctuation">.</span>Room <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This is almost everything that is needed to create an fps style multiplayer game. There are still some things left to do though. Sometimes we have to correct the local player if he predicted something wrong, that process is called reconciliation and we will implement it in the next section.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/EmbeddedFPSExample/guide/player-movement-interpolation-and-client-side-prediction.html" class="prev">
        Player-Movement, Interpolation and Client Side Prediction
      </a></span> <span class="next"><a href="/EmbeddedFPSExample/guide/reconciliation.html">
        Reconciliation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/EmbeddedFPSExample/assets/js/app.debd0cf8.js" defer></script><script src="/EmbeddedFPSExample/assets/js/2.6b282e9d.js" defer></script><script src="/EmbeddedFPSExample/assets/js/14.62a0b14a.js" defer></script>
  </body>
</html>
